#! /usr/bin/python3.7

import tempfile
from crontab import CronTab

import os
import argparse
import subprocess
from lxml import etree
from colorama import Fore, Back, Style
import signal
import sys
import time

__VERSION__ = "1.0.0";
__ROOTDIR__ = os.path.dirname(os.path.dirname(os.path.abspath(__file__)));

def wait(slist = [], wlist = []):

    plist = wlist + slist;
    def signal_handler(sig, frame):
        print('You pressed Ctrl+C.. Killing Symfony services..')
        for p in slist:
            os.killpg(os.getpgid(p.pid), signal.SIGTERM)
        for p in wlist:
            os.killpg(os.getpgid(p.pid), signal.SIGTERM)

    signal.signal(signal.SIGINT, signal_handler)
    time.sleep(0.5);

    # Check if apps is running
    print(Fore.GREEN + "-- Server daemon(s) running: " + str([p.pid for p in slist]) + Style.RESET_ALL)
    for p in slist:
        poll = p.poll()
        if not poll is None:
            print(Fore.RED + "-- Process [" + str(p.pid) + "] just crashed.." + Style.RESET_ALL);

    # Check if workers is running
    print(Fore.GREEN + "-- Worker daemon(s) running: " + str([p.pid for p in wlist]) + Style.RESET_ALL)
    for p in wlist:
        poll = p.poll()
        if not poll is None:
            print(Fore.RED + "-- Process [" + str(p.pid) + "] just crashed.." + Style.RESET_ALL);

    print('   * Press Ctrl+C to exit');
    return [p.wait() for p in plist];

def send_command(cmdlist, **kwargs):

    verbose = kwargs.get("verbose", False);
    pidfile = kwargs.get("pidfile", None);

    cwd     = kwargs.get("cwd", None);
    wd      = os.getcwd()
    os.chdir(cwd)

    stdout  = kwargs.get("stdout", None);
    stderr  = kwargs.get("stderr", None);
    if(type(stdout) == str): stdout = open(stdout, "w+");
    if(type(stderr) == str): stderr = open(stderr, "w+");

    plist = [];
    for cmd in cmdlist:
        plist.append(subprocess.Popen(cmd if type(cmd) == list else cmd.split(' '), stdout=stdout, stderr=stderr, cwd=cwd));

        if(verbose): print("@subprocess: "+ " ".join(cmd) + "; @return "+plist[-1].communicate()[0].strip().decode("utf-8"));
        if(pidfile): pidfile.write(" "+str(plist[-1].pid));

    if(stdout): stdout.close();
    if(stderr): stderr.close();
    os.chdir(wd)

    return plist;

def parse_xml(xmlfile):

    d = {};
    tree = etree.parse(xmlfile)

    for app in tree.xpath("//symfony/application"):

        path = app.get("path");
        if(path in d):
            print("This application already exists.. "+path, file=sys.stderr);
            exit(1);

        d[path] = {};
        d[path]["port"]   = app.get("port");

        d[path]["workers"] = [];
        for worker in app.xpath("worker"):
            d[path]["workers"].append({"transport": worker.get("transport")});

        d[path]["crontab"] = [];
        for cron in app.xpath("cron"):
            d[path]["crontab"].append({"name": cron.get("name"), "spec": cron.get("spec"), "cmd": cron.get("cmd")});

    return d;

def mktemp(**kwargs):
    prefix=kwargs.get("prefix","");
    suffix=kwargs.get("suffix","");
    return tempfile._get_default_tempdir() + "/" + prefix + next(tempfile._get_candidate_names()) + suffix;

if __name__ == "__main__":

    parser = argparse.ArgumentParser(description='Symfony Autoserve Arguments')
    parser.add_argument('--config', type=str,
                        default="/etc/symfony.xml",
                        help='Provide XML configuration file')
    parser.add_argument('--pidfile', type=str, default=mktemp(prefix="symfony-", suffix=".pid"),
                        help='Provide PID file for daemonize subprocess')
    parser.add_argument('--cronfile', type=str, default=mktemp(prefix="symfony-", suffix=".cron"),
                        help='Provide crontab file location')

    args = parser.parse_args()
    symfony = parse_xml(args.config);

    pidfile = args.pidfile;
    print(pidfile);
    if(type(pidfile) == str): pidfile = open(pidfile,"w");

    cronfile = args.cronfile;
    if(type(cronfile) == str): cronfile = open(cronfile,"w");

    print(Fore.MAGENTA + "-- Symfony Autoserve v"+__VERSION__+Style.RESET_ALL);
    print(Fore.GREEN + "-- Project Directory: "+Style.RESET_ALL + __ROOTDIR__);
    print(Fore.GREEN + "-- XML Configuration File: "+Style.RESET_ALL + args.config);
    if(pidfile): print(Fore.GREEN + "-- Writing PID here: "+ Style.RESET_ALL+ pidfile.name);
    if(cronfile): print(Fore.GREEN + "-- Writing crontab here: "+ Style.RESET_ALL+ cronfile.name);

    print(Fore.MAGENTA + "-- Starting server(s):"+ Style.RESET_ALL)
    if(pidfile): pidfile.write(str(os.getpid()));

    slist = [];
    for path in symfony:

        port = symfony[path]["port"];
        slist += send_command(
            ["symfony serve --port " + port],
            cwd=path, pidfile=pidfile,
            stdout="symfony-server.log"
        );
        print(Fore.GREEN + "   * New application: "+ Style.RESET_ALL +path+ " / "+Fore.GREEN+"Listening:"+Style.RESET_ALL+" https://127.0.0.1:"+port+" / "+Fore.GREEN+"PID:"+Style.RESET_ALL+" ["+str(slist[-1].pid)+"]"+Fore.CYAN+" (logs stored into symfony-server.log)"+Style.RESET_ALL);

        workers = symfony[path]["workers"];
        print(Fore.GREEN + "     It contains " + str(len(workers)) + " worker(s): "+ Style.RESET_ALL+str([w["transport"] for w in workers])+Fore.CYAN+" (logs stored into symfony-messenger.log)"+Style.RESET_ALL)
        wlist = [];
        for worker in workers:
            wlist += send_command(
                ["symfony console messenger:consume " + worker["transport"] + " -vv"],
                cwd=path, pidfile=pidfile, stdout="symfony-messenger.log"
            );

        crontab = symfony[path]["crontab"];
        print(Fore.GREEN + "     and also " + str(len(crontab)) + " cron task(s): "+ Style.RESET_ALL +str([cron["name"] for cron in crontab]) +Fore.CYAN+" (logs stored into symfony-crontab.log)"+Style.RESET_ALL);
        clist = [];
        for cron in crontab:
            cronfile.write(cron["spec"]+"\t"+cron["cmd"]+"\n");
        cronfile.close();

        wd = os.getcwd();
        os.chdir(path);
        cron = CronTab(user="www-data", tabfile=cronfile.name, log="symfony-crontab.log")
        os.chdir(wd);

    if(pidfile):
         pidfile.close();

    wait(slist,wlist);
